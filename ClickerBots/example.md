# Пример кликера для Lineage 2

Сейчас мы напишем простого бота кликера для известной MMORPG игры Lineage 2. В нём мы применим уже известные техники по перехвату и внедрению данных в игровое приложение.

## Обзор игры Lineage 2

Игровой процесс Lineage 2 очень типичен для жанра RPG. В начале надо выбрать одного из нескольких доступных персонажей. Для получения новых умений и покупки предметов игрок должен выполнять задания (или квесты) и охотиться на монстров. Этот процесс получения ресурсов называется "фарминг" (farming). Игроки всегда могут общаться и взаимодействовать между собой. Они могут помогать или мешать друг другу. Если несколько игроков хотят получить один и тот же нужный им ресурс, они должны сражаться за него. Этот элемент соперничества представляет наиболее привлекательную часть игры. Поэтому игроки стремяться как можно быстрее и лучше развить своего персонажа, чтобы сражаться с остальными.

Самый прямолинейный путь развития персонажа - это охота на монстров. После убийства каждого из них, игрок получает очки опыта для получения и улучшения своих умений, а также золото для покупки новых предметов. Мы попытаемся автоматизировать именно этот процесс, поскольку он ведёт к разностороннему развитию персонажа. В то же время есть и другие пути получения персонажем ресурсов: торговля, рыбалка, создание предметов и выполнение заданий.

Рассмотрим элементы игрового интерфейса изображенные на иллюстрации 2-12:

1. Окно состояния с параметрами персонажа игрока. Наиболее важные из них - это очки здоровья (health points или HP) и очки маны (mana points или MP).

2. Окно цели с информацией о выделенном в данный момент монстре. В нём есть полоска с HP цели.

3. Панель горячих клавиш с иконками возможных действий и доступных умений.

4. Окно чата для ввода игровых команд и отправки сообщений другим игрокам.

![Интерфейс Lineage 2](lineage-interface.png)

**Иллюстрация 2-12.** *Интерфейс Lineage 2*

Тщательное изучение интерфейса поможет вам в разработке алгоритма взаимодействия бота с игрой. Более подробно интерфейс описан на Wiki страничке (l2wiki.com/Game_Interface).

В интернете есть множество серверов Lineage 2. Они отличаются версией игры, дополнительными возможностями и системами защиты, которые предотвращают использование ботов. Наиболее эффектины такие системы на официальных серверах (www.lineage2.eu), созданных разработчиками игры. Кроме них есть так называемые пиратские сервера, которые поддерживаются энтузиастами. Как правило их защита значительно слабее. В нашем примере мы будем подключаться к серверу Rpg-Club (www.rpg-club.com).

## Реализация бота

Чтобы понять лучше механику игры, попробуйте убить нескольких монстров самостоятельно. Вы заметите, что почти всё время требуется нажимать одни и те же кнопки панели горячих клавиш. Пришло время составить алгоритм действий, которые мы хотим автоматизировать. Моя версия алгоримта выглядит следующим образом:

1. Выбрать монстра для атаки левым щелчком мыши по нему. Альтернативный способ - ввести следующую команду в окно чата:
```
/target ИмяМонстра

```
Полный лист игровых команд приведён на официальном сайте (l2wiki.com/classic/Commands). Также игрок может назначать несколько действий на одну клавишу с помощью макросов (l2wiki.com/classic/Macros).

2. Нажать кнопку "атака" на панели горячих клавиш. Это же действие можно выполнить с помощью клавиши F1.

3. Ожидать пока персонаж убьет монстра.

4. Нажать кнопку "подобрать" для сбора выпавших из монстра предметов и золота. Это действие так же можно выполнить по горячей клавише.

Этот алгоритм выглядит достаточно просто и не имеет никаких сложных условий. Напишем скрипт, чтобы автоматизировать его.

### Слепой бот

В качестве первой попытки мы будем строго следовать нашему алгоритму охоты на монстров. Бот будет симулировать нажатие клавиши на каждом шаге алгоритма. Этот кликер можно считать "слепым", потому что он не читает с экрана никакую информацию о состоянии игровых объектов.

Перед тем как мы начнём писать код, рассмотрим конфигурацию панели горячих клавиш. Вам нужно настроить её так же как на иллюстрации 2-13.

![Панели горячих клавиш](lineage-hotbar.png)

**Иллюстрация 2-12.** *Панели горячих клавиш*

Таблица 2-6 описывает конфигурацию панели.

**Таблица 2-6.** *Действия и соответствующие им горячие клавиши*

| Клавиша | Действие |
| --- | --- |
| F1 | Атаковать выделенного в данный момент монстра. |
| F2 | Использовать наступательной умение по текущей цели. |
| F5 | Использовать зелье лечения для восстановления HP. |
| F8 | Подобрать с земли предметы, лежащие около персонажа. |
| F9 | Макрос с командой `/target ИмяМонстра` для выбора цели. |
| F10 | Выбор ближайшего монстра. |

Теперь связать горячие клавиши с шагами алгоритма достаточно просто. Скрипт `BlindBot.au3`, приведённый в листинге 2-21, делает это.

**Листинг 2-21.** *Скрипт `BlindBot.au3`*

```AutoIt
#RequireAdmin

Sleep(2000)

while True
    Send("{F9}")
    Sleep(200)
    Send("{F1}")
    Sleep(5000)
    Send("{F8}")
    Sleep(1000)
wend
```
В первой строчке скрипта стоит ключевое слово `#RequireAdmin`. Оно разрешает скрипту взаимодействовать с другими приложениями независимо от того, какой пользователь их запустил. Некоторые клиенты Lineage 2 требуют для запуска прав администратора. Поэтому к ним не смогут получить доступ скрипты AutoIt, запущенные под пользователем с меньшими правами. Я рекоменду всегда использовать `#RequireAdmin` в ваших кликерах.

Первое действие скрипта - это двухсекундная задержка. Она нужна, чтобы вы успели переключится на окно Lineage 2. Текущая версия бота работает только с активным окном игры.

После вызова `Sleep` идёт бесконечный цикл `while`, в котором выполняются все действия бота:

1. `Send("{F9}")` - выбрать монстра с помощью макроса, настроенного на клавишу F9.

2. `Sleep(200)` - подождать 200 миллисекунд. Это время требуется клиенту Lineage 2, чтобы выделить монстра и отрисовать окно цели.

---
Помните, что все действия в окне игрового приложения происходят не мгновенно. Часто время на их выполнение намного меньше скорости реакции человека. Поэтому вы его не замечаете.
---

3. `Send("{F1}")` - атаковать выбранного монстра.

4. `Sleep(5000)` - ожидать пять секунд пока персонаж не подбежит к монстру и не убьёт его.

5. `Send("{F8}")` - подобрать один выпавший предмет.

5. `Sleep(1000)` - ждпть одну секунду, пока персонаж подбирает предмет.

В нашем примере последовательность действий бота строго определена. Поэтому каждое действие может завершиться успешно только в том случае, если предыдущее было также успешно. Прежде всего макрос выбора монстра должен отработать правильно. Если этот шаг не удался, все дальнейшие действия не имеют смысла. Затем персонаж должен подбежать к монстру и убить его за пять секунд. Это время может меняться в зависимости от расстояния до цели. Наконец, из монстра может выпасть более одного предмета. Наш скрипт будет работать правильно только если все перечисленные условия выполнятся, иначе неизбежны ошибки.

Вы можете запустить скрипт и проверить, как он работает. Часто бот будет совершать не те действия, которые нужны в данный момент, потому что одно из условий было нарушено. С другой стороны, ошибки - это не критичная проблема для бота, поскольку он продолжает свою работу. Это возможно благодаря особенности команды `/target` и механизму атаки цели. Если выполнить макрос `/target` дважды, бот будет атаковать уже выбранного монстра. Таким образом бот будет добивать свою цель. Даже если монстр выжил после первой итерации цикла `while`, атака на него продолжится в следующих итерациях. Кроме того, команда "поднять предмет" не прерывает атаку, если поблизости от персонажа нет предметов. Поэтому персонаж будет продолжать бить цель и после пятисекундной задержки.












